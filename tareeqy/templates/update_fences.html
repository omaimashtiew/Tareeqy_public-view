<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>Tareeqy Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        #map {
            height: 100vh;
            width: 100vw;
            touch-action: pan-x pan-y;
            /* Backface visibility for performance */
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            /* Transform for hardware acceleration */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            /* Image rendering for crisp edges */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        /* Smaller popup styling */
        .leaflet-popup-content {
            margin: 8px;
            font-size: 12px;
            line-height: 1.3;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialize map
        var map = L.map('map').setView([31.898043, 35.204269], 10);

        // Add tiles with retina detection
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            detectRetina: true
        }).addTo(map);

        // Smaller icons (20x20px)
        var icons = {
            open: L.icon({
                iconUrl: '{% static "images/open.png" %}',
                iconSize: [20, 20],
                iconAnchor: [10, 20],
                popupAnchor: [0, -20]
            }),
            closed: L.icon({
                iconUrl: '{% static "images/closed.png" %}',
                iconSize: [20, 20],
                iconAnchor: [10, 20],
                popupAnchor: [0, -20]
            }),
            traffic: L.icon({
                iconUrl: '{% static "images/traffic.png" %}',
                iconSize: [20, 20],
                iconAnchor: [10, 20],
                popupAnchor: [0, -20]
            })
        };

        // Load fence data
        var fences = JSON.parse('{{ fences_json|escapejs }}');

        // Add markers with smaller footprint
        fences.forEach(function(fence) {
            L.marker([fence.latitude, fence.longitude], {
                icon: icons[fence.status]
            }).bindPopup(`
                <div style="min-width:120px">
                    <strong>${fence.name}</strong><br>
                    <small>${fence.status}</small>
                </div>
            `, {
                maxWidth: 200,
                className: 'compact-popup'
            }).addTo(map);
        });

        // Mobile touch optimization
        if ('ontouchstart' in window) {
            map.dragging.enable();
            map.touchZoom.enable();
            document.getElementById('map').style.cursor = 'pointer';
            
            // Force higher resolution on mobile after a slight delay
            setTimeout(function() {
                map.invalidateSize(true);
            }, 200);
        }
    </script>
</body>
</html>