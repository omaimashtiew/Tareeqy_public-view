<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tareeqy</title>
    <link rel="icon" type="image/png" href="{% static 'images/road1.png' %}" /> <!-- Use static tag -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}"> <!-- Use static tag -->
    <style>
        /* Paste the styles from the previous complete HTML response here */
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 5px; }
        .custom-popup .leaflet-popup-content { margin: 0; padding: 0; line-height: 1.4; }
        .popup-header { padding: 8px 12px; font-weight: bold; color: white; border-top-left-radius: 5px; border-top-right-radius: 5px; }
        .popup-content { padding: 10px 12px; }
        .popup-item { display: flex; align-items: center; margin-bottom: 5px; font-size: 13px; }
        .popup-item:last-child { margin-bottom: 0; }
        .popup-icon { width: 20px; text-align: center; margin-right: 8px; color: #555; }
        .popup-item strong { color: #333; }
        .prediction-separator { border: 0; height: 1px; background-color: #eee; margin: 8px 0; }
        .prediction-info { color: #e67e22; } /* Orange for predictions */
        .prediction-error { color: #c0392b; } /* Red for errors */
        .search-result-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; overflow: hidden; font-size: 14px;}
        .search-result-item:hover { background-color: #f5f5f5; }
        .search-result-item .content-container { display: flex; align-items: center; width: 100%; }
        .search-result-item .status-dot { display: inline-block; flex-shrink: 0; width: 10px; height: 10px; border-radius: 50%; margin: 0 8px; }
        .search-result-item .name-container { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .no-results { padding: 10px; color: #777; font-style: italic; text-align: center; }
        .search-results { position: absolute; background-color: white; border: 1px solid #ddd; border-top: none; z-index: 1001; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 0 0 4px 4px; display: none; min-width: 220px; }
        #search-input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px 0 0 4px; width: 200px; font-size: 14px; }
        #location-loading, #location-error, #refresh-indicator, #refresh-error, #refresh-success, #prediction-loading, #prediction-error { position:absolute; top:80px; right:10px; background:white; padding:8px 12px; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:1000; max-width: 250px; }
        #location-error, #refresh-error, #prediction-error { background:#ffebee; border-left:4px solid #f44336; }
        #refresh-success { background:#e8f5e9; border-left:4px solid #4caf50; }
        #refresh-indicator { top:50%; left:50%; transform:translate(-50%,-50%); padding:15px; border-radius:50%; background:rgba(255,255,255,0.8); }
        #prediction-loading { border-left: 4px solid #3274d9; }
    </style>
</head>
<body>
    <!-- Paste the <div class="app-container">...</div> block from previous HTML response here -->
    <div class="app-container">
        <div class="header">
            <div class="logo"><i class="fas fa-route"></i> Tareeqy</div>
            <div class="nav-controls">
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Search checkpoint..."><button id="search-btn"><i class="fas fa-search"></i></button><div class="search-results"></div>
                </div>
                <button class="nav-btn" id="refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                <button class="nav-btn" id="info-btn"><i class="fas fa-info-circle"></i> About</button>
            </div>
        </div>
        
        <div class="content">
        
            <div class="sidebar" id="sidebar"><div class="sidebar-content"><div class="sidebar-header">Checkpoint Information  <div style="padding: 1rem; border-bottom: 1px solid #ccc;">
                <h3>üîç Search by City</h3>
                <input type="text" id="city-search" placeholder="Type city name..." class="form-control" style="width: 100%; padding: 8px; margin-bottom: 10px;" />
                <div id="search-results" style="max-height: 400px; overflow-y: auto;"></div>
            </div></div><div class="filter-section"><h3>Filter By Status</h3><div><input type="checkbox" id="show-open" checked><label for="show-open">Open</label></div><div><input type="checkbox" id="show-traffic" checked><label for="show-traffic">Traffic Jams</label></div><div><input type="checkbox" id="show-closed" checked><label for="show-closed">Closed</label></div></div><div class="info-section" style="margin-top: 20px;"><h3>Recent Updates</h3><div id="recent-updates"><p>Loading recent status updates...</p></div></div></div></div>
            <div id="map"></div>
            <div class="legend"><div class="legend-title">Status</div><div class="legend-item"><span class="legend-color legend-open"></span><span>Open</span></div><div class="legend-item"><span class="legend-color legend-traffic"></span><span>Traffic</span></div><div class="legend-item"><span class="legend-color legend-closed"></span><span>Closed</span></div></div>
            <button class="control-btn" id="toggle-sidebar"><i class="fas fa-bars"></i></button>
            <div class="map-controls"><button class="control-btn" id="locate-button"><i class="fas fa-crosshairs"></i></button><button class="control-btn" id="zoom-in"><i class="fas fa-plus"></i></button><button class="control-btn" id="zoom-out"><i class="fas fa-minus"></i></button></div>
        </div>
        
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
       
       document.getElementById('city-search').addEventListener('input', function () {
    const query = this.value.trim();
    const resultsContainer = document.getElementById('search-results');

    if (query.length < 2) {
        resultsContainer.innerHTML = '';
        return;
    }

    fetch(`/search-city?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            renderCitySearchResults(data);
        })
        .catch(error => {
            console.error('Error during city search:', error);
            resultsContainer.innerHTML = '<p style="padding: 8px; color: #dc3545; text-align: center;">Error loading results</p>';
        });
});

function renderCitySearchResults(results) {
    const container = document.getElementById('search-results');
    container.innerHTML = '';

    if (!results || results.length === 0) {
        container.innerHTML = '<p style="padding: 8px; color: #6c757d; text-align: center;">No results found</p>';
        return;
    }

    results.forEach(item => {
        const resultDiv = document.createElement('div');
        resultDiv.className = 'search-result-card';
        resultDiv.style = `
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            background: white;
            border: 1px solid #e0e0e0;
            text-align: right;
            direction: rtl;
        `;

        // Status color and icon
        const status = item.status || 'unknown';
        const statusColor = 
            status.toLowerCase() === 'open' ? '#28a745' :
            status.toLowerCase() === 'closed' ? '#dc3545' :
            '#6c757d'; // default color
        
        const statusIcon = status.toLowerCase() === 'open' ? '‚úì ' : '‚úó ';

        // Format time
        const formattedTime = formatTime(item.message_time);

        resultDiv.innerHTML = `
            <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 4px;">${item.name}</div>
            <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 8px;">${item.city}</div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: ${statusColor}; font-size: 0.9rem;">
                    ${statusIcon}${status}
                </span>
                <span style="font-size: 0.8rem; color: #6c757d;">
                    ${formattedTime}
                </span>
            </div>
        `;

        container.appendChild(resultDiv);
    });
}

function formatTime(isoString) {
    if (!isoString) return 'No update time';
    
    try {
        const date = new Date(isoString);
        const now = new Date();
        const diffInDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
        
        if (diffInDays === 0) {
            // Today - show time only
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else if (diffInDays === 1) {
            // Yesterday
            return 'Yesterday';
        } else {
            // Older dates
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        }
    } catch (e) {
        console.error('Error formatting date:', e);
        return '';
    }
}




        // Paste the ENTIRE <script> block from the previous complete HTML response here
        // (Starting from document.addEventListener('DOMContentLoaded', function() { ... down to the end)
        document.addEventListener('DOMContentLoaded', function() {
            // --- Map Initialization ---
            var map = L.map('map', { zoomControl: false }).setView([31.9522, 35.2332], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors', detectRetina: true }).addTo(map);
            // --- State Variables ---
            var userLocation = null, userLocationMarker = null, accuracyCircle = null;
            var markerLayers = { open: L.layerGroup().addTo(map), closed: L.layerGroup().addTo(map), sever_traffic_jam: L.layerGroup().addTo(map), unknown: L.layerGroup().addTo(map) };
            var checkpointMarkers = {}; // Stores L.marker objects keyed by fence.id
            // --- Icons and Styles ---
            var icons = { /* Icons definition */
                open: L.divIcon({ html: '<div style="background-color: #28a745; width: 14px; height: 14px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>', className: 'checkpoint-marker', iconSize: [20, 20], iconAnchor: [10, 10] }),
                closed: L.divIcon({ html: '<div style="background-color: #dc3545; width: 14px; height: 14px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>', className: 'checkpoint-marker', iconSize: [20, 20], iconAnchor: [10, 10] }),
                sever_traffic_jam: L.divIcon({ html: '<div style="background-color: #ffc107; width: 14px; height: 14px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>', className: 'checkpoint-marker', iconSize: [20, 20], iconAnchor: [10, 10] }),
                unknown: L.divIcon({ html: '<div style="background-color: #888; width: 14px; height: 14px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>', className: 'checkpoint-marker', iconSize: [20, 20], iconAnchor: [10, 10] }), // Added unknown icon
                userLocation: L.divIcon({ html: '<div style="background-color: #3274d9; width: 14px; height: 14px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>', className: 'user-marker', iconSize: [20, 20], iconAnchor: [10, 10] })
             };
            var statusStyles = { /* Status Styles definition */
                open: { color: '#28a745', icon: 'fa-check-circle', label: 'Open', headerColor: '#28a745' },
                closed: { color: '#dc3545', icon: 'fa-times-circle', label: 'Closed', headerColor: '#dc3545' },
                sever_traffic_jam: { color: '#ffc107', icon: 'fa-exclamation-triangle', label: 'Severe Traffic', headerColor: '#ffc107' },
                unknown: { color: '#888', icon: 'fa-question-circle', label: 'Unknown', headerColor: '#888' } // Added unknown style
             };
            // --- Helper Functions ---
            function formatTime(isoString) { try { return !isoString ? "N/A" : new Date(isoString).toLocaleTimeString([], { hour: 'numeric', minute:'2-digit', hour12: true }).replace(/^0+/, ''); } catch(e){ return "Invalid Time";}}
            function formatDateTime(isoString) { try { return !isoString ? "N/A" : new Date(isoString).toLocaleString([], { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }).replace(':00 ', ' '); } catch(e) { return "Invalid Date"; }}
            function getCookie(name) { let v = null; if(document.cookie && document.cookie !== '') { const c = document.cookie.split(';'); for (let i = 0; i < c.length; i++) { let C = c[i].trim(); if (C.substring(0, name.length + 1) === (name + '=')) { v = decodeURIComponent(C.substring(name.length + 1)); break; }}} return v; }
            function showTemporaryMessage(id, content, isError = false, duration = 3000) { removeTemporaryMessage(id); const el = document.createElement('div'); el.id = id; el.innerHTML = content; el.style.cssText = 'position:absolute; top:80px; right:10px; background:white; padding:10px; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:1000; max-width:250px; border-left: 4px solid #ddd;'; if (isError) { el.style.borderColor = '#f44336'; el.style.backgroundColor = '#ffebee'; } document.querySelector('.content').appendChild(el); if (duration > 0) { setTimeout(() => removeTemporaryMessage(id), duration); } }
            function removeTemporaryMessage(id) { const el = document.getElementById(id); if (el) el.remove(); }
            function isRTL(text) { const rtlChars = /[\u0591-\u07FF\u200F\u202B\u202E\uFB1D-\uFDFD\uFE70-\uFEFC]/; return typeof text === 'string' && rtlChars.test(text); }
            // --- Popup Content Creation ---
            function createPopupContent(fenceInfo) {
                const status = fenceInfo.status || 'unknown';
                const style = statusStyles[status] || statusStyles['unknown'];
                const updatedTime = formatDateTime(fenceInfo.message_time || fenceInfo.status_time_iso);
                return `<div><div class="popup-header" style="background-color: ${style.headerColor};">${fenceInfo.name || 'Unnamed'}</div><div class="popup-content"><div class="popup-item"><span class="popup-icon"><i class="fas ${style.icon}"></i></span><span>Status: <strong>${style.label}</strong></span></div><div class="popup-item"><span class="popup-icon"><i class="fas fa-clock"></i></span><span>Updated: ${updatedTime}</span></div><div class="prediction-placeholder"></div></div></div>`;
            }
             // --- Update Popups with Prediction Data ---
            function updateMapWithPredictions(predictedFences) {
                 console.log("Updating map/UI with predictions...");
                 predictedFences.forEach(fencePred => {
                     const marker = checkpointMarkers[fencePred.id];
                     if (marker) {
                         let basePopupHTML = createPopupContent({ name: fencePred.name, status: fencePred.current_status, message_time: fencePred.status_time_iso });
                         let predictionHTML = '';
                         if (fencePred.prediction_success && fencePred.predicted_jam_probability_percent !== null) {
                            predictionHTML = `<hr class="prediction-separator"><div class="popup-item prediction-info"><span class="popup-icon"><i class="fas fa-hourglass-half"></i></span><span>Est. Arrival: ~${formatTime(fencePred.prediction_arrival_time_iso)}</span></div><div class="popup-item prediction-info"><span class="popup-icon"><i class="fas fa-car-crash"></i></span><span>Jam Risk: <strong>${fencePred.predicted_jam_probability_percent}%</strong></span></div>`;
                         } else if (fencePred.prediction_error) {
                            predictionHTML = `<hr class="prediction-separator"><div class="popup-item prediction-error"><span class="popup-icon"><i class="fas fa-exclamation-circle"></i></span><span>Prediction: ${fencePred.prediction_error}</span></div>`;
                         }
                         marker.setPopupContent(basePopupHTML.replace('<div class="prediction-placeholder"></div>', predictionHTML));
                     }
                 });
                 console.log("Map popups updated with predictions.");
            }
            // --- Recent Updates Sidebar ---
            function updateRecentList(updates) {
                 const container = document.getElementById('recent-updates');
                 if (!updates || updates.length === 0) { container.innerHTML = '<p>No recent updates.</p>'; return; }
                 let html = '';
                 updates.forEach(update => {
                     const status = update.status || 'unknown';
                     const style = statusStyles[status] || statusStyles['unknown'];
                     html += `<div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #eee;"><div><strong>${update.name}</strong></div><div style="color: ${style.color}; margin: 3px 0;"><i class="fas ${style.icon}"></i> ${style.label}</div><div style="font-size: 12px; color: #777;"><i class="fas fa-clock"></i> ${formatDateTime(update.time)}</div></div>`;
                 });
                 container.innerHTML = html;
            }
            // --- Initial Data Loading ---
            var initialFenceDataForSearch = []; // Use this for search
            try {
                const fences = JSON.parse('{{ fences_json|escapejs }}'); // Passed from map_view
                const recentUpdates = [];
                const allMarkersList = [];
                fences.forEach(function(fence) {
                    const status = fence.status || 'unknown';
                    // Skip rendering marker if coordinates are invalid (0,0 or null)
                    if (!fence.latitude || !fence.longitude || (parseFloat(fence.latitude) === 0 && parseFloat(fence.longitude) === 0)) return;
                    const iconToUse = icons[status] || icons['unknown'];
                    const popupContent = createPopupContent(fence);
                    const marker = L.marker([fence.latitude, fence.longitude], { icon: iconToUse });
                    marker.bindPopup(popupContent, { className: 'custom-popup', maxWidth: 300 });
                    const layerGroup = markerLayers[status] || markerLayers['unknown'];
                    marker.addTo(layerGroup);
                    allMarkersList.push(marker);
                    checkpointMarkers[fence.id] = marker; // Store marker by ID
                    initialFenceDataForSearch.push({ id: fence.id, name: fence.name, status: status, latitude: fence.latitude, longitude: fence.longitude, marker: marker });
                    if (fence.message_time) { recentUpdates.push({ name: fence.name, status: status, time: fence.message_time }); }
                });
                recentUpdates.sort((a,b) => new Date(b.time) - new Date(a.time));
                updateRecentList(recentUpdates.slice(0, 5));
                if (allMarkersList.length > 0) { map.fitBounds(L.featureGroup(allMarkersList).getBounds().pad(0.2)); }
            } catch (e) { console.error("Fatal Error loading initial fence data:", e); document.getElementById('recent-updates').innerHTML = '<p class="error">Error loading map data. Check console.</p>'; }
            // --- Location Handling & API Call ---
            function locateUser() { map.locate({ setView: true, maxZoom: 16, enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }); showTemporaryMessage('location-loading', '<i class="fas fa-spinner fa-spin"></i> Finding location...', false, 0); }
            map.on('locationerror', (e) => { removeTemporaryMessage('location-loading'); const m = { 1: "Access denied.", 2: "Position unavailable.", 3: "Timed out." }[e.code] || "Unknown error."; showTemporaryMessage('location-error', `<strong>Location Error</strong><br>${m}`, true, 5000); });
            map.on('locationfound', (e) => {
                userLocation = e.latlng; console.log("User location found:", userLocation); removeTemporaryMessage('location-loading');
                if (userLocationMarker) map.removeLayer(userLocationMarker); if (accuracyCircle) map.removeLayer(accuracyCircle);
                userLocationMarker = L.marker(userLocation, { icon: icons.userLocation }).addTo(map).bindPopup("Your location").openPopup();
                accuracyCircle = L.circle(userLocation, e.accuracy / 2, { color: '#3274d9', fillColor: '#3274d9', fillOpacity: 0.15, weight: 1 }).addTo(map);
                if (map.getZoom() < 13) map.setView(userLocation, 13);
                // Fetch predictions
                console.log("Sending location to backend for predictions...");
                showTemporaryMessage('prediction-loading', '<i class="fas fa-brain fa-spin"></i> Getting predictions...', false, 0);
                fetch('/api/get_predictions/', { // *** ENSURE THIS URL IS CORRECT ***
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify({ latitude: userLocation.lat, longitude: userLocation.lng })
                })
                .then(response => response.ok ? response.json() : response.json().then(err => { throw new Error(err.error || `Server error: ${response.status}`) }).catch(() => { throw new Error(`HTTP error ${response.status}`) }))
                .then(data => { removeTemporaryMessage('prediction-loading'); if (data.error) throw new Error(data.error); updateMapWithPredictions(data.fences); })
                .catch(error => { removeTemporaryMessage('prediction-loading'); console.error('Prediction fetch error:', error); showTemporaryMessage('prediction-error', `<strong>Prediction Error</strong><br>${error.message}`, true, 5000); });
            });
            // --- Search Functionality ---
            const searchInput = document.getElementById('search-input'); const searchBtn = document.getElementById('search-btn'); const searchResultsContainer = document.querySelector('.search-results');
            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('input', () => { searchInput.value.length > 0 ? performSearch() : clearSearchResults(); });
            searchInput.addEventListener('keyup', e => { if (e.key === 'Enter') performSearch(); });
            document.addEventListener('click', (e) => { if (!searchResultsContainer.contains(e.target) && e.target !== searchInput && !searchBtn.contains(e.target) ) clearSearchResults(); });
            function performSearch() {
                const term = searchInput.value.trim().toLowerCase(); clearSearchResults(); if (!term) return;
                const results = initialFenceDataForSearch.filter(fence => fence.name.toLowerCase().includes(term)); // Use separate data array
                if (results.length === 0) { searchResultsContainer.innerHTML = '<div class="no-results">No checkpoints found</div>'; }
                else { results.forEach(r => { const item = document.createElement('div'); item.className = 'search-result-item'; const style = statusStyles[r.status] || statusStyles['unknown']; const color = style.color; item.innerHTML = `<div class="content-container" style="direction: ${isRTL(r.name) ? 'rtl' : 'ltr'};"><span class="status-dot" style="background-color: ${color};"></span><span class="name-container"></span></div>`; item.querySelector('.name-container').textContent = r.name; item.onclick = () => { map.setView([r.latitude, r.longitude], 14); if(r.marker) r.marker.openPopup(); clearSearchResults(); searchInput.value = ''; }; searchResultsContainer.appendChild(item); }); }
                searchResultsContainer.style.display = 'block';
            }
            function clearSearchResults() { searchResultsContainer.innerHTML = ''; searchResultsContainer.style.display = 'none'; }
            // --- UI Controls ---
            document.getElementById('locate-button').addEventListener('click', locateUser);
            document.getElementById('zoom-in').addEventListener('click', () => map.zoomIn()); document.getElementById('zoom-out').addEventListener('click', () => map.zoomOut());
            document.getElementById('toggle-sidebar').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('active'));
            document.getElementById('show-open').addEventListener('change', e => toggleLayerVisibility(markerLayers.open, e.target.checked));
            document.getElementById('show-traffic').addEventListener('change', e => toggleLayerVisibility(markerLayers.sever_traffic_jam, e.target.checked));
            document.getElementById('show-closed').addEventListener('change', e => toggleLayerVisibility(markerLayers.closed, e.target.checked));
            function toggleLayerVisibility(layer, show) { if (layer) { show ? map.addLayer(layer) : map.removeLayer(layer); } }
            document.getElementById('refresh-btn').addEventListener('click', () => { showTemporaryMessage('refresh-indicator', '<i class="fas fa-sync-alt fa-spin fa-2x"></i>', false, 0); window.location.reload(); }); // Simple reload
            document.getElementById('info-btn').addEventListener('click', () => alert('Tareeqy: Checkpoint status and traffic prediction.\n(Prediction is based on historical data and estimated arrival time.)'));
            // --- Initial action ---
            locateUser(); // Attempt initial location
        }); // End DOMContentLoaded
    </script>
</body>
</html>

