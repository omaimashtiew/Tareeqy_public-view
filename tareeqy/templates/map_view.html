<!DOCTYPE html>
{% load static %}
<html lang="ar" dir="rtl"> <!-- Changed lang to 'ar' and added dir="rtl" -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>طريقي</title> <!-- Changed title -->
    <link rel="icon" type="image/png" href="{% static 'images/road1.png' %}" />
    
    <!-- External CSS Libraries -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Your Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <div class="app-container">
        <!-- Header - Adapted from purple design -->
        <nav class="navbar fixed-top app-header">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"> 
                  <img src="{% static 'images/road1.png' %}" alt="شعار طريقي" width="30" height="30" class="d-inline-block align-text-top">
                  طريقي
                </a>
                <div class="search-container">
                    <input type="text" id="search-input" class="form-control" placeholder="ابحث عن حاجز أو مدينة..." aria-label="Search checkpoint or city">
                    <button id="search-btn" class="btn btn-search-icon" aria-label="Execute search" type="button"><i class="fas fa-search"></i></button>
                    <div class="search-results"></div>
                </div>
            </div>
        </nav>
        
        <div class="content-wrapper" id="content-wrapper">
            <!-- Sidebar - Adapted from your "before code" but styled like purple design -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-content">
                    <div class="sidebar-header">
                        <span>معلومات نقاط التفتيش</span>
                        <button type="button" class="btn-close btn-close-sidebar" id="close-sidebar-btn" aria-label="إغلاق القائمة الجانبية"></button>
                    </div>
                    
                    <div class="filter-section mb-3">
                        <h3><i class="fas fa-filter me-2"></i>تصفية حسب الحالة</h3>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filter-open" value="open" checked>
                            <label class="form-check-label" for="filter-open">مفتوح</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filter-traffic" value="sever_traffic_jam" checked>
                            <label class="form-check-label" for="filter-traffic">ازدحام مروري</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filter-closed" value="closed" checked>
                            <label class="form-check-label" for="filter-closed">مغلق</label>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3><i class="fas fa-history me-2"></i>آخر التحديثات</h3>
                        <div id="recent-updates-list" class="recent-updates-list">
                            <p class="text-muted p-2 text-center">جاري تحميل التحديثات...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="map"></div>

        </div> <!-- End content-wrapper -->
        
        <!-- Footer Navigation - From purple design -->
        <nav class="navbar fixed-bottom footer-nav">
            <div class="container-fluid p-0">
                <div class="row w-100 m-0">
                    <div class="col-4 p-0">
                        <div class="nav-item" id="footer-update-btn" role="button" tabindex="0" aria-label="Update data">
                            <i class="fas fa-sync-alt"></i>
                            <span>تحديث</span>
                        </div>
                    </div>
                    <div class="col-4 p-0">
                        <div class="nav-item" id="footer-toggle-sidebar-btn" role="button" tabindex="0" aria-label="Toggle list menu">
                            <i class="fas fa-list"></i>
                            <span>القائمة</span>
                        </div>
                    </div>
                    <div class="col-4 p-0">
                        <div class="nav-item" id="footer-go-btn" role="button" tabindex="0" aria-label="Plan route">
                            <i class="fas fa-route"></i>
                            <span>انطلق</span>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Status Legend - from your "before code", adapted -->
        <div class="status-legend" id="status-legend">
            <div class="status-title">مفتاح الحالة</div>
            <div class="status-item"><span class="status-color status-open"></span><span>مفتوح</span></div>
            <div class="status-item"><span class="status-color status-traffic"></span><span>ازدحام</span></div>
            <div class="status-item"><span class="status-color status-closed"></span><span>مغلق</span></div>
        </div>

        <!-- Map Controls - FAB and Zoom, from purple design -->
        <button class="btn fab-location" id="locate-user-btn" title="تحديد موقعي" aria-label="Locate me">
            <i class="fas fa-crosshairs"></i>
        </button>
        <div class="zoom-controls">
            <button class="btn zoom-btn" id="zoom-in-btn" title="تكبير" aria-label="Zoom in"><i class="fas fa-plus"></i></button>
            <button class="btn zoom-btn" id="zoom-out-btn" title="تصغير" aria-label="Zoom out"><i class="fas fa-minus"></i></button>
        </div>

        <!-- Modals (Route Planning, Location Error) -->
        <div class="modal fade" id="route-modal" tabindex="-1" aria-labelledby="routeModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="routeModalLabel">إلى أين وجهتك؟</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                    </div>
                    <div class="modal-body">
                        <div class="input-group mb-3">
                            <input type="text" id="destination-input" class="form-control" placeholder="أدخل وجهتك هنا...">
                            <button class="btn btn-outline-primary" type="button" id="plan-route-btn">
                                <i class="fas fa-paper-plane me-1"></i> خطط
                            </button>
                        </div>
                        <div id="recent-destinations-container">
                            <div class="recent-title">الوجهات الأخيرة</div>
                            <div id="recent-destinations-list" class="recent-destinations-list">
                                <div class="no-recent text-muted p-2 text-center">لا توجد وجهات محفوظة.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="location-error-modal" tabindex="-1" aria-labelledby="locationErrorModalLabel" aria-hidden="true">
             <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="locationErrorModalLabel"><i class="fas fa-exclamation-triangle me-2"></i>خطأ في تحديد الموقع</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                    </div>
                    <div class="modal-body">
                        <p>لم نتمكن من الوصول إلى موقعك الحالي. قد يكون ذلك بسبب:</p>
                        <ul>
                            <li>تم رفض إذن الوصول للموقع.</li>
                            <li>خدمة تحديد المواقع (GPS) غير مفعلة في جهازك.</li>
                            <li>لا توجد إشارة GPS جيدة.</li>
                        </ul>
                        <p>يرجى التحقق من الإعدادات والمحاولة مرة أخرى.</p>
                        <div class="safari-help mt-3">
                            <h6>إذا كنت تستخدم Safari على iPhone:</h6>
                            <ol>
                                <li>اذهب إلى <strong>الإعدادات</strong> <i class="fas fa-cog"></i>.</li>
                                <li>مرر لأسفل واختر <strong>Safari</strong>.</li>
                                <li>اختر <strong>الموقع</strong>.</li>
                                <li>تأكد من تحديد <strong>"السؤال"</strong> أو <strong>"السماح"</strong>.</li>
                                <li>تأكد من تفعيل <strong>"الموقع الدقيق"</strong>.</li>
                            </ol>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                        <button type="button" class="btn btn-primary" id="retry-location-modal-btn">حاول مرة أخرى</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container position-fixed p-3"></div>
    </div>

    <!-- External JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- App Data Passed from Django View -->
    <script>
        const FENCES_DATA_JSON = `{{ fences_json|escapejs }}`;
        const CSRF_TOKEN = "{{ csrf_token }}";
        const API_URL_GET_PREDICTIONS = "{% url 'tareeqy_app:api_get_predictions' %}"; 
        const API_URL_SEARCH_CITY_OR_FENCE = "{% url 'tareeqy_app:api_search_city_or_fence' %}";
    </script>

    <!-- Application JavaScript Modules -->
    <script src="{% static 'js/map_config.js' %}"></script>
    <script src="{% static 'js/ui_interactions.js' %}"></script> 
    <script src="{% static 'js/data_handler.js' %}"></script>
    <script src="{% static 'js/location.js' %}"></script>
    <script src="{% static 'js/search.js' %}"></script>
    <script src="{% static 'js/route_planner.js' %}"></script>
    <script src="{% static 'js/main_map.js' %}"></script>
</body>
</html>